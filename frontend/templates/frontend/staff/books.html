{% extends 'frontend/staff/base.html' %}

{% block staff_content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Book Management</h1>
</div>

<!-- Search and Filter -->
<div class="row mb-4">
    <div class="col-md-8">
        <form class="d-flex" id="searchForm">
            <input type="text" class="form-control me-2" id="searchInput" placeholder="Search by NL Code">
            <select class="form-select me-2" id="statusFilter" style="width: auto;">
                <option value="">All Statuses</option>
                <option value="NOR">Normal</option>
                <option value="BOR">Borrowed</option>
                <option value="OVD">Overdue</option>
                <option value="LOS">Lost</option>
            </select>
            <button class="btn btn-outline-primary" type="submit">Search</button>
        </form>
    </div>
</div>

<!-- Books Table -->
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>NL Code</th>
                <th>Title</th>
                <th>Author</th>
                <th>Status</th>
                <th>Current Borrower</th>
                <th>Due Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for book in books %}
            <tr>
                <td>
                    <a href="{% url 'frontend:book_detail' book.id %}">{{ book.nl_code }}</a>
                </td>
                <td>{{ book.profile.title }}</td>
                <td>{{ book.profile.author }}</td>
                <td>
                    <span class="badge bg-{{ book.status|lower }}">
                        {{ book.get_status_display }}
                    </span>
                </td>
                <td>
                    {% if book.current_borrow %}
                        {{ book.current_borrow.borrower.user.username }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    {% if book.current_borrow %}
                        {{ book.current_borrow.due_date|date:"Y-m-d" }}
                    {% else %}
                        -
                    {% endif %}
                </td>
                <td>
                    <a href="{% url 'frontend:book_detail' book.id %}" class="btn btn-sm btn-info">
                        <i class="bi bi-eye"></i>
                    </a>
                    {% if book.status == 'BOR' or book.status == 'OVD' %}
                        <button class="btn btn-sm btn-success return-book" 
                                data-book-id="{{ book.id }}"
                                data-nl-code="{{ book.nl_code }}">
                            Return
                        </button>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Return Confirmation Modal -->
<div class="modal fade" id="returnModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Return Book</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to return book <span id="returnBookCode"></span>?</p>
                <form id="returnForm">
                    <div class="mb-3">
                        <label class="form-label">Notes (optional)</label>
                        <textarea class="form-control" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmReturn">Confirm Return</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const returnModal = new bootstrap.Modal(document.getElementById('returnModal'));
    let currentBookId = null;

    // Handle return button clicks
    document.querySelectorAll('.return-book').forEach(button => {
        button.addEventListener('click', function() {
            currentBookId = this.dataset.bookId;
            document.getElementById('returnBookCode').textContent = this.dataset.nlCode;
            returnModal.show();
        });
    });

    // Handle return confirmation
    document.getElementById('confirmReturn').addEventListener('click', async function() {
        if (!currentBookId) return;

        const notes = document.querySelector('#returnForm [name="notes"]').value;
        
        try {
            const response = await fetch('{% url "circulation:return_book" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({
                    book_id: currentBookId,
                    notes: notes
                })
            });

            const data = await response.json();
            
            if (response.ok) {
                window.location.reload();
            } else {
                alert(data.message || 'An error occurred');
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An error occurred while processing your request');
        }
    });

    // Handle search and filter
    document.getElementById('searchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const search = document.getElementById('searchInput').value;
        const status = document.getElementById('statusFilter').value;
        
        window.location.href = `?search=${encodeURIComponent(search)}&status=${encodeURIComponent(status)}`;
    });
});
</script>
{% endblock %} 